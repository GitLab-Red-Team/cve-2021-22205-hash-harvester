package storage

import (
	"context"
	"gitlab.com/gitlab-red-team/private-research/cve-2021-22205-hash-generator/tags"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

const (
	DB = "cve_2021_22205"
)

type TagQueryParams struct {
	GetMongoURI func() string
	Tag         tags.Tag
}

type CheckMongoConnection func(func())

func getMongoClient(mongoURI string, checkMongoConnection CheckMongoConnection) (*mongo.Client, error) {
	var clientInstance *mongo.Client
	var clientInstanceError error
	checkMongoConnection(func() {
		clientOptions := options.Client().ApplyURI(mongoURI)
		client, err := mongo.Connect(context.TODO(), clientOptions)
		if err != nil {
			clientInstanceError = err
		}
		err = client.Ping(context.TODO(), nil)
		if err != nil {
			clientInstanceError = err
		}
		clientInstance = client
	})
	return clientInstance, clientInstanceError
}

func GetTag(tq TagQueryParams, checkMongoConnection CheckMongoConnection) (tags.Tag, error) {
	_, _ = getMongoClient(tq.GetMongoURI(), checkMongoConnection)
	return tags.Tag{}, nil
}
