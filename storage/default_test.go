package storage_test

import (
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/suite"
	"gitlab.com/gitlab-red-team/private-research/cve-2021-22205-hash-generator/storage"
	"gitlab.com/gitlab-red-team/private-research/cve-2021-22205-hash-generator/tags"
	"testing"
)

type StorageTestSuite struct {
	suite.Suite
	ExpectedTag                tags.Tag
	ActualTag                  tags.Tag
	Error                      error
	IsCheckMongoFunctionCalled bool
}

func (suite *StorageTestSuite) SetupTest() {
	tagQuery := storage.TagQueryParams{
		GetMongoURI: func() string {
			return ""
		},
		Tag: tags.Tag{Name: "gitlab"},
	}
	checkMongoConnectionNoop := func(func()) {
		suite.IsCheckMongoFunctionCalled = true
	}
	suite.ActualTag, suite.Error = storage.GetTag(tagQuery, checkMongoConnectionNoop)
}

func (suite *StorageTestSuite) TestGetTagCallsCheckMongoConnection() {
	assert.True(suite.T(), suite.IsCheckMongoFunctionCalled)
}

func TestStorageTestSuite(t *testing.T) {
	suite.Run(t, new(StorageTestSuite))
}
