package io_test

import (
	"fmt"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/suite"
	"gitlab.com/gitlab-red-team/private-research/cve-2021-22205-hash-generator/io"
	"os"
	"testing"
)

type ioTestSuite struct {
	suite.Suite
	WriteFileError1      error
	WriteFileError2      error
	WriteFileError3      error
	FileName             string
	ActualFileContent    []byte
	FileContentError     error
	ExpectedFileContent1 string
	ExpectedFileContent2 string
	RepeatedFileContent  error
	EnvVarLoaderNoError  io.EnvironmentVariableLoader
	GetEnvNoError        io.GetEnv
	ExpectedMongoURI     string
	ActualMongoURI       string
}

func (suite *ioTestSuite) SetupTest() {
	suite.FileName = "./test-file.txt"
	suite.ExpectedFileContent1 = "some_hash_value"
	suite.ExpectedFileContent2 = "another_hash_value"
	suite.WriteFileError1 = io.WriteUniqueHashToFile(suite.ExpectedFileContent1, suite.FileName)
	suite.WriteFileError2 = io.WriteUniqueHashToFile(suite.ExpectedFileContent2, suite.FileName)
	suite.WriteFileError3 = io.WriteUniqueHashToFile(suite.ExpectedFileContent1, suite.FileName)
	suite.ActualFileContent, suite.FileContentError = os.ReadFile(suite.FileName)
	suite.ExpectedMongoURI = "mongodb://root:password@mongo:27017/"
	suite.EnvVarLoaderNoError = func(filenames ...string) error {
		return nil
	}
	suite.GetEnvNoError = func(key string) string {
		return suite.ExpectedMongoURI
	}
	suite.ActualMongoURI = io.GetMongodbURI(suite.EnvVarLoaderNoError, suite.GetEnvNoError)
}

func (suite *ioTestSuite) TearDownTest() {
	_ = os.Remove(suite.FileName)
}

func (suite *ioTestSuite) TestWriteHashToFile() {
	assert.Nil(suite.T(), suite.WriteFileError1)
	assert.Nil(suite.T(), suite.WriteFileError2)
	assert.Nil(suite.T(), suite.WriteFileError3)
}

func (suite *ioTestSuite) TestFileContentIsPresent() {
	assert.Equal(suite.T(),
		fmt.Sprintf("%s\n%s\n", suite.ExpectedFileContent1, suite.ExpectedFileContent2),
		string(suite.ActualFileContent))
}

func (suite *ioTestSuite) TestEnvVarRetrieval() {
	assert.Equal(suite.T(), suite.ExpectedMongoURI, suite.ActualMongoURI)
}

func TestIoTestSuite(t *testing.T) {
	suite.Run(t, new(ioTestSuite))
}
